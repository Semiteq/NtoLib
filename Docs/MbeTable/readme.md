# Функциональный блок "Таблица рецептов MBE" (MbeTableFB)

**MbeTableFB** — это гибкий функциональный блок для **MasterSCADA 3.12**, предназначенный для создания, управления и
исполнения технологических рецептов.

![MbeTableFB](../img/MbeTableFB.png)

## Оглавление

| # | Раздел | Описание |
|---|--------|----------|
| 1 | [Конфигурация (YAML)](01-config.md) | Формат файлов, порядок загрузки, правила валидации |
| 2 | [Контракт пинов](02-infrastructure.md) | Входные/выходные пины FB, таймеры |
| 3 | [UI/UX](03-presentation.md) | Режимы выбора, навигация, операции со строками |
| 4 | [Импорт/экспорт CSV](04-csv.md) | Формат файла, метаданные, валидация |
| 5 | [Modbus TCP](05-modbus-tcp.md) | Протокол обмена с ПЛК, карта памяти |
| 6 | [Диагностика](06-logger.md) | Логирование, ротация, формат записей |

## 1. Ключевые возможности

- Гибкая настройка: Вся бизнес-логика, структура таблицы и набор команд определяются в текстовых YAML-файлах.
- Динамический интерфейс: Пользовательский интерфейс (столбцы, редакторы, выпадающие списки) генерируется автоматически
  на основе конфигурации.
- Мониторинг в реальном времени: Отслеживание исполнения рецепта, подсветка текущего шага и расчет оставшегося времени
  до конца шага и рецепта.
- Интеграция с ПЛК: Прямое взаимодействие с контроллерами по протоколу Modbus TCP для записи параметров рецепта.
- Динамическое создание пинов: Пины для связи с оборудованием создаются автоматически на основе файла
  `PinGroupDefs.yaml`.

## 2. Требования к окружению

- Среда исполнения: MasterSCADA 3.12.
- Зависимости: .NET Framework 4.8.

## 3. Установка и первоначальная настройка

1. Установка библиотеки:
    - Скопируйте библиотеку `NtoLib.dll` и `System.Resources.Extensions.dll` в корневую папку установки MasterSCADA.
    - Зарегистрируйте сборку с помощью утилиты `netreg.exe`.
2. Создание папки конфигурации:
    - В корневой директории, где установлена MasterSCADA, создайте папку с именем `NtoLibTableConfig`.
3. Размещение конфигурационных файлов:
    - Поместите в папку `NtoLibTableConfig` четыре обязательных YAML-файла (готовые темплейты для проектов можно найти
      по [ссылке](../../MbeTable/DefaultConfig)):
        - `PropertyDefs.yaml`
        - `PinGroupDefs.yaml`
        - `ColumnDefs.yaml`
        - `ActionsDefs.yaml`
4. Добавление блока в проект:
    - Перезапустите среду разработки MasterSCADA.
    - Добавьте функциональный блок "Таблица рецептов MBE" на схему в вашем проекте.

## Поведение при загрузке

- Загрузка конфига стартует либо по клику объекта в дереве (т.к. нужно отобразить пины), либо по переходу на экран с
  объектом (смотря что произойдет раньше).
- Для повторной загрузки нужно перезапустить MasterSCADA, чтобы инициировать объект заново.

## Поведение для отдельных вендоров

| Поведение          | Mitsubishi | Siemens |
|--------------------|------------|---------|
| Порядок бит        | lowhigh    | highlow |
| Задержки ModbusTCP | 200-300мс  | 1с      |
| UnitID             | 1          | 69      |
