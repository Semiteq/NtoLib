# LinkSwitcher — Перелинковка связей между структурно идентичными объектами

Функциональный блок для автоматической перелинковки всех внешних связей между парами структурно идентичных объектов в дереве проекта MasterSCADA.

---

## 1. Назначение

В проектах MasterSCADA используется оборудование с идентичной структурой (например, `Termodat` / `Termodat2`). При необходимости подменить один прибор другим требуется перенести все связи с одного объекта на другой. Ручная перелинковка десятков каналов с десятками пинов в каждом -- трудоёмкая и ошибкоопасная операция.

LinkSwitcher автоматизирует этот процесс:

- находит все пары объектов по паттерну `<Name>` / `<Name>2` среди прямых потомков контейнера;
- валидирует структурную идентичность каждой пары;
- переносит все внешние связи (обычные и с обратной связью) с одного объекта пары на другой;
- операция ставится в очередь в Runtime и выполняется при переходе в Design mode.

---

## 2. Интерфейс

### Входы (Pin)

| ID | Имя | Тип | Описание |
|----|-----|-----|----------|
| 1 | Execute | Логический | Фронт `false -> true` запускает операцию (сканирование, валидация, постановка в очередь) |
| 2 | Forward | Логический | `true` -- прямое направление (`<Name>` -> `<Name>2`), `false` -- обратное (`<Name>2` -> `<Name>`) |
| 3 | DryRun | Логический | `true` -- только сканирование и логирование, без реальной перелинковки |
| 4 | Cancel | Логический | Фронт `false -> true` отменяет ожидающую операцию (пока не перешли в Design mode) |

### Выходы (Pout)

| ID | Имя | Тип | Описание |
|----|-----|-----|----------|
| 101 | Success | Логический | `true` если сканирование/валидация завершились без ошибок. Не отражает результат отложенного исполнения (см. раздел 7) |
| 104 | IsPending | Логический | `true` если задача в очереди, ожидает перехода в Design mode |

### Параметры (окно настроек)

| Свойство | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| Путь для поиска пар объектов | string | `Система.АРМ1.OPC UA Siemens.ServerInterfaces.MBE` | Путь к контейнеру в дереве проекта, в котором ищутся пары `<Name>` / `<Name>2` |

---

## 3. Структура данных в дереве

### 3.1. Контейнер и пары объектов

На вход подаётся путь `SearchPath` (через окно настроек) -- контейнер, в котором ФБ ищет пары.

Пары определяются среди **прямых потомков** контейнера по паттерну имени:

```text
SearchPath/
├── Termodat          <-- <Name>
├── Termodat2         <-- <Name>2   -> пара найдена
├── Vacuummeter       <-- <Name>
├── Vacuummeter2      <-- <Name>2   -> пара найдена
├── Recipe            <-- нет Recipe2 -> игнорируется
└── ...
```

Объекты, для которых пара не найдена, игнорируются без ошибки.

### 3.2. Внутренняя структура объектов пары

Объекты в паре должны быть **структурно идентичны**: одинаковые дочерние элементы на всех уровнях вложенности, одинаковые пины с одинаковыми именами.

```text
Termodat/                    Termodat2/
├── CH1                      ├── CH1
│   ├── StatusWord           │   ├── StatusWord
│   ├── ControlWord          │   ├── ControlWord
│   ├── Kp                   │   ├── Kp
│   ├── Ki                   │   ├── Ki
│   ├── MaxPower             │   ├── MaxPower
│   ├── TemperatureSP        │   ├── TemperatureSP
│   ├── ActualTemperature    │   ├── ActualTemperature
│   ├── ActualPower          │   ├── ActualPower
│   ├── Kd                   │   ├── Kd
│   ├── RampSpeed            │   ├── RampSpeed
│   └── ActualTempSP         │   └── ActualTempSP
├── CH2                      ├── CH2
│   └── ...                  │   └── ...
└── CH16                     └── CH16
    └── ...                      └── ...
```

Если структура не совпадает -- это ошибка валидации, вся операция прерывается.

---

## 4. Перелинковка

### 4.1. Что такое перелинковка

Перелинковка -- это перенос внешних связей с пинов объекта-источника на соответствующие пины объекта-приёмника. Связь **удаляется** из источника и **создаётся** в приёмнике.

```text
До перелинковки (прямое направление, Termodat -> Termodat2):

  OPC_Server.Tag1 ──связь──> Termodat.CH1.StatusWord
  Termodat.CH1.ActualTemperature ──связь──> HMI.Display1

После перелинковки:

  OPC_Server.Tag1 ──связь──> Termodat2.CH1.StatusWord
  Termodat2.CH1.ActualTemperature ──связь──> HMI.Display1
```

### 4.2. Сопоставление пинов

Пины сопоставляются по относительному пути внутри объекта:

```text
Источник: SearchPath.Termodat.CH1.StatusWord
Приёмник: SearchPath.Termodat2.CH1.StatusWord
                                ^^^^^^^^^^^
Относительный путь: CH1.StatusWord (совпадает по имени)
```

### 4.3. Типы связей

Переносятся **все** типы связей:
- обычные связи;
- связи с обратной связью.

### 4.4. Внутренние связи

Связи между пинами внутри одного и того же объекта **не переносятся** -- обрабатываются только внешние связи.

### 4.5. Направление переключения

Управляется входным пином `Forward`:
- `Forward = true` (прямое): связи переносятся с `<Name>` на `<Name>2`;
- `Forward = false` (обратное): связи переносятся с `<Name>2` на `<Name>`.

Направление единое для всех пар, найденных за один вызов.

### 4.6. Отсутствие связей

Если у объекта-источника нет внешних связей для переноса -- ничего не делаем, ошибки нет.

---

## 5. Режимы работы: Runtime / Design

MasterSCADA запрещает модификацию связей в Runtime. Поэтому:

1. В **Runtime** при фронте `Execute` ФБ выполняет сканирование дерева, валидацию структуры, формирование плана операций и ставит задачу в очередь.
2. При переходе в **Design mode** ФБ ставит задачу на отложенное исполнение через `BeginInvoke` на STA-потоке.
3. Отложенная задача выполняется после того, как `IProjectHlp.InRuntime` переходит в `false` (после `RTManager.Done()`).
4. Результат отложенного исполнения записывается в лог-файл на диске (см. раздел 7).

---

## 6. Логика работы

### 6.1. Сканирование и валидация (Runtime, по фронту Execute)

1. Проверить, что `SearchPath` не пуст и объект по указанному пути существует.
2. Найти все пары `<Name>` / `<Name>2` среди прямых потомков контейнера.
3. Для каждой найденной пары:
   - рекурсивно обойти внутреннюю структуру обоих объектов;
   - проверить структурную идентичность (одинаковые дочерние элементы и пины на всех уровнях);
   - собрать список всех внешних связей (обычных и с обратной связью) на пинах объекта-источника.
4. Если на этапе валидации обнаружено **любое** структурное несоответствие -- **вся операция прерывается**:
   - `Success = false`;
   - подробности ошибки записываются в лог-файл;
   - `IsPending = false`;
   - перелинковка не выполняется ни для одной пары.
5. Если пар не найдено -- операция завершается с ошибкой, в лог-файле отражается, что пары не обнаружены.

### 6.2. Формирование плана и постановка в очередь (Runtime)

Если валидация прошла:

1. Сформировать план операций: для каждой связи -- откуда отсоединить, куда присоединить.
2. Записать план в лог-файл.
3. Если `DryRun = true`:
   - `Success = true`;
   - `IsPending = false`;
   - операция завершена, в лог-файле содержится полный план без исполнения.
4. Если `DryRun = false`:
   - задача поставлена в очередь;
   - `IsPending = true`;
   - ожидание перехода в Design mode.

### 6.3. Исполнение (Design mode, отложенное через BeginInvoke)

При переходе в Design mode:

1. ФБ проверяет наличие ожидающей задачи.
2. Через `MasterSCADAHlp.Instance.ThreadHolder.BeginInvoke()` задача ставится в очередь STA-потока.
3. Задача исполняется после того, как `RTManager.Done()` установит `InRuntime = false`.
4. Для каждой операции из плана:
   - выполняется отсоединение связи от пина источника;
   - выполняется присоединение связи к пину приёмника;
   - результат записывается в лог-файл.
5. Если операция для конкретного пина завершилась ошибкой:
   - ошибка фиксируется в лог-файле;
   - исполнение **продолжается** для остальных пинов.
6. Итоговый результат (количество успешных и ошибочных операций) записывается в лог-файл.

> **Примечание:** Результат отложенного исполнения не отражается на выходных пинах. MasterSCADA заменяет экземпляр ФБ между циклами Runtime, поэтому буферизация результатов в полях ФБ невозможна. Лог-файл является единственным источником информации о результате исполнения.

### 6.4. Отмена операции (Runtime, по фронту Cancel)

По фронту `Cancel`:

1. Если `IsPending = true` -- задача удаляется из очереди.
2. `IsPending = false`.
3. Факт отмены записывается в лог-файл.

---

## 7. Логирование

Все события (сканирование, валидация, план, исполнение, ошибки) записываются в файл на диске:

- **Путь:** `C:\DISTR\Logs\link-switcher.log`
- **Ротация:** по размеру файла (5 МБ), без ротации по дате
- **Количество файлов:** до 5 (старые удаляются)
- **Формат записи:** `{Timestamp:O} [{Level:u3}] {Message}{NewLine}{Exception}`

Пример содержимого лог-файла:

```text
2026-02-10T12:00:01.1234567+00:00 [INF] === LinkSwitcherFB: Scan === Path: "PlasmaSource", Direction: "Forward (Name -> Name2)"
2026-02-10T12:00:01.1234600+00:00 [INF] Discovered 2 pairs
2026-02-10T12:00:01.1234700+00:00 [INF]   [1] "Termodat" / "Termodat2"
2026-02-10T12:00:01.1234800+00:00 [INF]   [2] "Vacuummeter" / "Vacuummeter2"
2026-02-10T12:00:01.1235000+00:00 [INF]   "Termodat": structure OK, links to transfer: 42
2026-02-10T12:00:01.1235100+00:00 [INF]   "Vacuummeter": structure OK, links to transfer: 8
2026-02-10T12:00:01.1236000+00:00 [INF] Links to transfer (50):
2026-02-10T12:00:01.1236100+00:00 [INF]   "Termodat.CH1.StatusWord" "<-" "OPC.Tag1" => "Termodat2.CH1.StatusWord"
...
2026-02-10T12:00:15.5000000+00:00 [INF] === LinkSwitcherFB: Execution ===
2026-02-10T12:00:15.5001000+00:00 [INF]   [OK] "Termodat.CH1.StatusWord" "<-" "OPC.Tag1" => "Termodat2.CH1.StatusWord"
2026-02-10T12:00:15.5100000+00:00 [ERR]   [ERROR] "Termodat.CH5.Kp" "<-" "OPC.Tag5": "Link operation failed: <description>"
...
2026-02-10T12:00:15.6000000+00:00 [WRN] Result: 49 of 50 links transferred, 1 errors
2026-02-10T12:00:15.6000100+00:00 [INF] Deferred execution completed successfully
```

При DryRun:

```text
2026-02-10T12:00:01.1240000+00:00 [INF] === DryRun complete: no links were modified ===
```

При отмене:

```text
2026-02-10T12:00:01.1240000+00:00 [INF] === LinkSwitcherFB: Operation cancelled by user ===
```

---

## 8. Обработка ошибок

### 8.1. Ошибки валидации (прерывают всю операцию)

| Ситуация | Поведение |
|----------|-----------|
| `SearchPath` пуст или объект не найден | `Success = false`, подробности в лог-файле |
| Пары `<Name>` / `<Name>2` не найдены | `Success = false`, подробности в лог-файле |
| Структурное несоответствие в любой паре | `Success = false`, вся операция отменена, подробности в лог-файле |

### 8.2. Ошибки исполнения (не прерывают операцию)

| Ситуация | Поведение |
|----------|-----------|
| Не удалось найти пин по пути | Ошибка в лог-файле, переход к следующей операции |
| Не удалось отсоединить/присоединить конкретную связь | Ошибка в лог-файле, переход к следующей связи |
| Часть связей не перенесена | Сводка ошибок в лог-файле |
| Все связи перенесены | Сводка успеха в лог-файле |

### 8.3. Ошибки инициализации

| Ситуация | Поведение |
|----------|-----------|
| `TreeItemHlp.Project` недоступен | `Success = false`, ошибка в лог-файле, блок не обрабатывает команды |

---

## 9. Особенности поведения

- **Отложенное исполнение:**
  Перелинковка выполняется не в момент команды, а при переходе из Runtime в Design mode. Результат записывается в лог-файл.

- **Замена экземпляра ФБ:**
  MasterSCADA заменяет экземпляр ФБ между циклами Runtime (десериализация из снимка, сделанного до исполнения). Поэтому буферизация результатов в полях ФБ невозможна. Результат отложенного исполнения доступен только в лог-файле.

- **Пин Success отражает только сканирование/валидацию:**
  Выходной пин `Success` показывает результат сканирования и валидации, выполненных в текущем Runtime. Он не отражает результат отложенного исполнения перелинковки.

- **Атомарность на уровне пар:**
  Валидация выполняется для всех пар сразу. Если хотя бы одна пара не прошла валидацию -- ни одна связь не будет перенесена.

- **Неатомарность на уровне связей:**
  При исполнении ошибка отдельной связи не прерывает перенос остальных. Частично перенесённые связи остаются в новом состоянии -- механизма отката нет.

- **Повторный запуск:**
  Каждый фронт `Execute` полностью перестраивает план на основании текущего состояния дерева. Предыдущий план (если не был исполнен) заменяется новым.
