# TrendPensManager — Управление перьями графиков

![TrendPensManagerFB.png](TrendPensManagerFB.png)

Функциональный блок автоматически подбирает перья для трендов и добавляет их в открытое окно графиков на основании структуры сервисов в дереве и данных из ConfigLoader.

---

## 1. Основные возможности

- Обход сервисов под корнем `DataRootPath` (БКТ, БП, БУЗ, Вакуумметры, Пирометр, Турбины, Крио, Ионные, Интерферометр и другие).
- Управляемое включение/исключение сервисов из обработки через параметры `Add...`.
- Автоматическое добавление перьев для каналов с `Used == true`.
- Именование перьев по данным из ConfigLoader (для БКТ, БП, БУЗ).
- Сохранение существующих перьев (только добавление новых).
- Логирование всех операций и ошибок.

**Критично:** Окно "Тренд" для `TrendRootPath` должно быть открыто во время выполнения блока.  
Структура дерева под `TrendRootPath` не влияет на алгоритм обхода сервисов.

---

## 2. Интерфейс

### Входы (Pin)

**Execute** (bool)  
Положительный фронт `0 → 1` запускает цикл обработки:
- валидация входных параметров и структуры дерева;
- чтение выходов ConfigLoader и проверка размерностей;
- подбор перьев для добавления в тренд;
- добавление перьев в открытое окно тренда.

### Выходы (Pout)

**Executing** (bool)  
Устанавливается в `true` на время выполнения операции автонастройки.  
После завершения (успех или ошибка) устанавливается в `false`.

**Success** (bool)  
Устанавливается в `true` на 1 секунду после **полного успешного завершения** операции:
- нет структурных ошибок;
- нет ошибок чтения ConfigLoader и несоответствий размерностей;
- все операции добавления перьев в окно тренда выполнены без ошибок SCADA.

При любой ошибке `Success` не поднимается.

**Logs** (string)  
Строка логов выполнения. Перезаписывается при каждом запуске.  
Содержит информационные сообщения, отладочные сообщения и предупреждения.

**Errors** (string)  
Строка ошибок. Перезаписывается при каждом запуске.  
Содержит только критические ошибки:

- ошибки валидации входных путей;
- ошибки структуры дерева (включая отсутствие `Used`);
- ошибки чтения/размерностей ConfigLoader;
- ошибки, возвращённые SCADA при добавлении перьев (нет пина, нет прав, сбои AddParametr, отсутствие настроек пера и т.д.).

При отсутствии ошибок `Errors` — пустая строка.

### Параметры (окно настроек)

#### Пути в дереве

**TrendRootPath** (string)  
Путь к объекту "Графики" (корень тренд-объекта), для которого выполняется автонастройка:
- по этому пути находится объект тренда;
- по нему же ищется открытое окно тренда;
- этот путь используется как `TrendPath` при построении перьев.

Структура дочерних узлов под `TrendRootPath` на алгоритм обхода **не влияет**.

**ConfigLoaderRootPath** (string)  
Путь к блоку ConfigLoader в дереве MasterSCADA.  
Формат: `PLZ_Inject.Config.Загрузчик конфигурации` (через точку, пробелы не экранируются).

**DataRootPath** (string)  
Путь к корню сервисов, из которых берутся каналы и параметры для построения перьев.  
По умолчанию соответствует прежнему расположению сервисов под `TrendRootPath`.  
Именно под `DataRootPath` ожидается структура вида:

```text
DataRootPath
├── БКТ
├── БП
├── БУЗ
├── Вакуумметры
├── Пирометр
├── Турбины
├── Крио
├── Ионные
└── Интерферометр
```

Алгоритм обхода сервисов и каналов полностью основан на структуре под `DataRootPath`.

#### Управление включением сервисов

Для каждого типа сервиса предусмотрен отдельный булевый параметр.  
Все параметры по умолчанию равны `true`, что соответствует поведению “обрабатывать все сервисы”, как в исходной версии.

**AddHeaters** (bool, по умолчанию `true`)  
Добавлять сервисы “БКТ” (тип `Heaters`).

**AddChamberHeaters** (bool, по умолчанию `true`)  
Добавлять сервисы “БП” (тип `ChamberHeaters`).

**AddShutters** (bool, по умолчанию `true`)  
Добавлять сервисы “БУЗ” (тип `Shutters`).

**AddVacuumMeters** (bool, по умолчанию `true`)  
Добавлять сервисы “Вакуумметры”.

**AddPyrometer** (bool, по умолчанию `true`)  
Добавлять сервис “Пирометр”.

**AddTurbines** (bool, по умолчанию `true`)  
Добавлять сервис “Турбины”.

**AddCryo** (bool, по умолчанию `true`)  
Добавлять сервис “Крио”.

**AddIon** (bool, по умолчанию `true`)  
Добавлять сервис “Ионные”.

**AddInterferometer** (bool, по умолчанию `true`)  
Добавлять сервис “Интерферометр”.

Если флаг `Add...` для соответствующего сервиса равен `false`, сервис полностью пропускается при обходе под `DataRootPath` (его каналы не обрабатываются и перья не добавляются).  
Ситуация, когда все флаги отключены, не является ошибкой: блок корректно отработает, но не добавит ни одного пера.

---

## 3. Структура данных в дереве

### 3.1. Поддерево сервисов (источник данных)

```text
DataRootPath
├── БКТ
│   ├── Канал1
│   │   ├── T1 (pin)
│   │   ├── P1 (pin)
│   │   └── Used (bool pin)
│   └── Канал2
│       ├── T1
│       ├── P1
│       └── Used
├── БП
│   └── Канал_1
│       ├── T1
│       └── Used
├── БУЗ
│   └── Channel1
│       ├── T1
│       └── Used
├── Вакуумметры
│   └── ...
├── Пирометр
│   └── ...
├── Турбины
│   └── ...
├── Крио
│   └── ...
├── Ионные
│   └── ...
└── Интерферометр
    └── ...
```

**Требования к структуре под `DataRootPath`:**

- Первый уровень под `DataRootPath` — объекты сервисов:
    - `БКТ`, `БП`, `БУЗ`, `Вакуумметры`, `Пирометр`, `Турбины`, `Крио`, `Ионные`, `Интерферометр` и при необходимости другие.
- Алгоритм обхода учитывает параметры `Add...`:
    - если для конкретного сервиса флаг `Add...` равен `false`, сервис пропускается полностью;
    - иначе он обрабатывается в полном объёме.
- Второй уровень — каналы сервиса (например: `Канал1`, `Channel_3`).
- Название канала должно заканчиваться цифрой (например: `Канал1`, `Channel_3`); эта цифра используется как номер канала.
- В каждом канале обязательно присутствует параметр `Used` (bool-пин).  
  Отсутствие `Used` считается **ошибкой структуры**.
- Остальные пины канала рассматриваются как параметры канала (тип не проверяется).
- Если `Used == false` — канал пропускается (перья для него не добавляются), но это не является ошибкой.

### 3.2. Связь с ConfigLoader

Блок использует массивы выходов ConfigLoader для именования перьев **только для сервисов типов БКТ, БП, БУЗ**:

| Тип сервиса | Имя узла сервиса под DataRootPath | Массив ConfigLoader            | Размер массива | Индексация                       |
|-------------|------------------------------------|--------------------------------|----------------|----------------------------------|
| Heaters     | `БКТ`                              | `Sources_OUT[1..32]`           | 32             | Номер канала = индекс массива   |
| ChamberHeaters | `БП`                           | `ChamberHeaters_OUT[1..16]`    | 16             | Номер канала = индекс массива   |
| Shutters    | `БУЗ`                              | `Shutters_OUT[1..16]`          | 16             | Номер канала = индекс массива   |
| Прочие      | `Вакуумметры`, `Пирометр`, `Турбины`, `Крио`, `Ионные`, `Интерферометр` и т.д. | — | — | Имена из ConfigLoader не используются |

**Жёсткие требования:**

- Для сервисов типов БКТ, БП, БУЗ:
    - Группы `Sources_OUT`, `ChamberHeaters_OUT`, `Shutters_OUT` должны существовать в ConfigLoader.
    - Внутри каждой группы должны существовать пины `1..N` (где `N` = фиксированному размеру массива).
    - Группа не должна быть полностью пустой (все значения не должны быть одновременно пустыми).
- Первое обнаруженное несоответствие (отсутствие группы, пина, полностью пустая группа и т.п.) считается **критической ошибкой**:
    - подбор перьев для тренда не выполняется;
    - перья в тренд не добавляются;
    - `Errors` содержит описание ошибки;
    - `Success` остаётся `false`.

**Критично:** Номер канала (например, `5` в `Канал5`) должен соответствовать валидному индексу в массиве ConfigLoader.  
Выход за границы массива для типов БКТ, БП, БУЗ — **критическая ошибка**.

---

## 4. Правила именования перьев

### Для БКТ, БП, БУЗ

Формат имени пера:

```text
<ИмяПараметра> <ИмяИзКонфига>
```

**Примеры:**

- `T1 Источник верхний`
- `P1 Нагреватель камеры 2`
- `T2 Заслонка левая`

где:

- `<ИмяПараметра>` — имя пина параметра канала (`T1`, `P1`, `T2` и т.д.).
- `<ИмяИзКонфига>` — строка из соответствующего массива ConfigLoader.

Если для указанного сервиса нет данных ConfigLoader или индекс канала выходит за пределы массива — это считается **критической ошибкой**, подбор перьев для тренда не выполняется.

### Для остальных сервисов

Для сервисов, не относящихся к БКТ, БП, БУЗ (в том числе `Вакуумметры`, `Пирометр`, `Турбины`, `Крио`, `Ионные`, `Интерферометр`):

- Имена из ConfigLoader не используются;
- Имя пера = имя параметра (`<ИмяПараметра>`).

---

## 5. Алгоритм работы

### Шаг 1: Валидация входных данных

1. Проверка, что строки `ConfigLoaderRootPath`, `TrendRootPath` и `DataRootPath` не пустые.
2. Поиск узлов в дереве проекта:
    - Узел `TrendRootPath` (корень тренд-объекта).
    - Узел `ConfigLoaderRootPath` (блок ConfigLoader).
    - Узел `DataRootPath` (корень сервисов).
3. Если любой из узлов не найден — критическая ошибка.

При критической ошибке:

- `Executing` кратковременно переходит в `true` на время попытки и затем в `false`.
- `Success = false`.
- `Errors` содержит описание проблемы.
- `Logs` содержит подробный лог.
- Перья не добавляются.

### Шаг 2: Проверка структуры дерева сервисов и фильтрация по Add...

1. Сканирование **первого уровня** дочерних узлов под `DataRootPath` как сервисов.
2. Для каждого сервиса:
    - По имени сервиса определяется его тип (`Heaters`, `ChamberHeaters`, `Shutters` или “прочие”).
    - Проверяется соответствующий флаг `Add...`:
        - если флаг `false` — сервис полностью пропускается;
        - если флаг `true` — сервис обрабатывается.
3. Для каждого обрабатываемого сервиса:
    - Перебор дочерних узлов как каналов.
    - Определение номера канала по цифровому суффиксу имени.
    - Поиск пина `Used` (регистронезависимо).
    - Чтение значения `Used` (преобразование из bool/int/double/других типов).
4. Для каждого канала:
    - Если пин `Used` отсутствует или его невозможно прочитать — **структурная ошибка**, выполнение прерывается.
    - При `Used == true` — канал включается в обработку и участвует в подборе перьев.
    - При `Used == false` — канал игнорируется без ошибки.
    - Все остальные пины канала (кроме `Used`) включаются в список параметров.

По итогам блок формирует внутренний список каналов и предупреждений:

- `Channels` — список каналов (с `Used == true` и `Used == false`), только для тех сервисов, по которым флаг `Add... == true`.
- `Warnings` — несущественные предупреждения (например, нестандартные конструкции, не влияющие на корректность).

При любой структурной ошибке:

- внутренняя операция автонастройки перьев завершается с ошибкой;
- перья не добавляются.

### Шаг 3: Чтение ConfigLoader и проверка размерностей

1. По заданному `ConfigLoaderRootPath` находится блок ConfigLoader.
2. Для каждого поддерживаемого сервиса (БКТ, БП, БУЗ) читаются группы:
    - `Sources_OUT[1..32]`,
    - `ChamberHeaters_OUT[1..16]`,
    - `Shutters_OUT[1..16]`.
3. Для каждой группы:
    - Проверяется существование узла группы.
    - Проверяется наличие каждого пина `1..N`.
    - Получается строковое значение пина.
    - Проверяется, что группа не полностью пустая (есть хотя бы одно непустое значение).

**Критические ошибки:**

- Группа не найдена.
- Отсутствует любой из обязательных пинов `1..N`.
- Группа полностью пустая.

При критической ошибке:

- внутренняя операция автонастройки перьев завершается с ошибкой;
- перья не добавляются.

Номер канала интерпретируется как индекс массива `1..N`:

- Если номер канала для БКТ, БП, БУЗ выходит за пределы соответствующего массива — **критическая ошибка**, выполнение прерывается.

### Шаг 4: Подбор перьев для добавления в тренд

На основе:

- списка каналов, полученных на предыдущих шагах;
- массивов имён из ConfigLoader;
- пути `TrendRootPath`,

внутри блока формируется список перьев для добавления в тренд:

- для каждого пера указывается `SourcePinPath` — полный путь к пину параметра;
- `TrendPath` — путь к корню трендов (значение `TrendRootPath`);
- `PenDisplayName` — сформированное имя пера;
- `Warnings` — предупреждения (если есть, не являются критическими).

**Правила:**

- Каналы с `Used == false` игнорируются при подборе перьев.
- Сервисы, для которых соответствующий флаг `Add... == false`, полностью исключаются из обработки.
- Для сервисов типов БКТ, БП, БУЗ:
    - Для каждого канала обязательно должно существовать имя в массиве ConfigLoader по индексу `ChannelNumber`.
    - Отсутствие данных для типа сервиса или выход индекса за пределы массива — критическая ошибка.
- Для остальных сервисов:
    - Имена из ConfigLoader не используются;
    - Имя пера = имя параметра.

**Поведение:**

- При первом обнаруженном критическом несоответствии (конфликт размерностей, отсутствующие данные) подбор перьев прерывается, перья не добавляются.

### Шаг 5: Добавление перьев в тренд

1. По `TrendRootPath` находится объект тренда.
2. Через сервис трендов находится открытое окно тренда, соответствующее этому объекту.
    - Если окно не открыто — ошибка «Trend window is closed».
3. Перед добавлением перьев:
    - Устанавливается предел по количеству параметров (`MaxParameters = 1000`), то есть за один запуск блок не добавит более 1000 перьев в один тренд.
4. Для каждого подготовленного пера:
    - По `SourcePinPath` находится пин.
    - Проверяются права на добавление пера.
    - Выполняется добавление пера методом SCADA (`AddParametr` или аналог).
    - Для добавленного пера определяется его настройка, обновляется отображаемое имя пользователя (`UserName`) и устанавливается стиль отображения графика "ступенькой" (staircase), чтобы дискретные изменения были наглядно видны на тренде.

**Ошибки SCADA:**

Для каждого пера могут возникнуть следующие ошибки:

- Пин не найден.
- Нет прав на добавление пера.
- Окно тренда не инициализировано или не поддерживает добавление.
- Метод добавления (`AddParametr`) вернул ошибку или null.
- Не удалось найти настройки пера в коллекции настроек тренда.

Все такие ошибки:

- Накопительно добавляются в список ошибок.
- Логируются как ошибки.
- Не прерывают обработку остальных перьев (следующие элементы продолжают обрабатываться).

**Итоговое поведение:**

- Если список ошибок добавления перьев непустой:
    - `AutoConfigurePens` возвращает ошибку.
    - `Success` не поднимается.
- Если все перья добавлены без ошибок:
    - `AutoConfigurePens` возвращает успех.
    - В FB поднимается `Success` на 1 секунду.

Предупреждения (например, пропущенные неиспользуемые каналы, отключённые флагами сервисы) не влияют на итоговый статус и не попадают в `Errors`, но отражаются в логах и `Warnings`.

---

## 6. Поведение выходов блока

### Перед стартом выполнения (на фронт Execute):

- `Executing` устанавливается в `true`.
- `Success` принудительно сбрасывается в `false`.
- `Logs` очищается.
- `Errors` очищается.

### При успешном завершении:

- `Executing` устанавливается в `false`.
- `Success` устанавливается в `true` на 1 секунду, затем автоматически сбрасывается в `false`.
- `Logs` содержит полную историю выполнения.
- `Errors` — пустая строка.

### При завершении с ошибкой:

- `Executing` устанавливается в `false`.
- `Success` остаётся `false`.
- `Logs` содержит подробный лог.
- `Errors` содержит одну или несколько ошибок, объединённых по разделителю (формат определяется реализацией; в текущей реализации это строка с конкатенацией текстов ошибок).

---

## 7. Особенности поведения

- **Неразрушающая работа:**  
  Существующие перья не удаляются и не модифицируются. Блок добавляет только новые перья.

- **Проверка дубликатов:**  
  Выполняется средствами SCADA. Блок не реализует свою логику проверки дубликатов и опирается на поведение `AddParametr`.

- **Отсутствие отката:**  
  Нет механизма отката при частичной ошибке. Если некоторые перья были успешно добавлены, они остаются в тренде.

- **Повторный запуск:**  
  При каждом запуске:
    - `Logs` и `Errors` перезаписываются.
    - Список перьев формируется заново по текущему состоянию дерева `DataRootPath`, параметрам `Add...` и состоянию ConfigLoader.
    - Добавление перьев производится с учётом уже существующих настроек тренда (поведение при дубликатах — см. реализацию SCADA).

- **Фильтрация сервисов флагами Add...:**  
  Флаги `Add...` позволяют гибко управлять, какие именно сервисы из поддерева `DataRootPath` участвуют в автонастройке перьев, без изменения структуры проекта в дереве.
