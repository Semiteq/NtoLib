# Контракт пинов (MBE Recipe Table)

## Входные пины (Inputs)

- RecipeActive (ID: 1, bool)
    - Назначение: признак, что рецепт исполняется.
    - Влияние на поведение:
        - При true редактирование таблицы блокируется (таблица становится «только чтение»).
        - Считается состоянием «BUSY», что блокирует операции (загрузка/передача рецепта).

- ActualLineNumber (ID: 3, int)
    - Назначение: номер текущей исполняемой строки/шага.
    - Индексация: начинается с 0.
    - Влияние на поведение:
        - Подсвечивает пройденные и текущие строки согласно цветовой схеме.
        - Изменение вызывает событие инвалидации таблицы.

- StepCurrentTime (ID: 4, float)
    - Назначение: время, прошедшее с начала текущего шага.
    - Единицы: секунды.
    - Влияние на поведение:
        - Участвует в расчетах `LineTimeLeft` и `TotalTimeLeft`.

- ForLoopCount1 (ID: 5, int)
- ForLoopCount2 (ID: 6, int)
- ForLoopCount3 (ID: 7, int)
    - Назначение: номера итераций для отслеживания вложенных циклов FOR (1-й, 2-й и 3-й уровень).
    - Влияние на поведение:
        - Изменение трактуется как смена строки.

- EnaSend (ID: 8, bool)
    - Назначение: глобальное разрешение на отправку данных в ПЛК (Modbus).
    - Влияние на поведение:
        - При false операции, требующие записи рецепта в ПЛК, считаются запрещенными.
        - Считается входом для расчета разрешений UI (должно быть true и система не должна быть «занята», чтобы
          позволить запись).

При работе с пинами ожидается состояние каждого "Good" (должны содержать значение или иметь привязку к источнику), иначе алгоритм будет пропускать выполнение. 

## Выходные пины (Outputs)

- TotalTimeLeft (ID: 101, float)
    - Назначение: расчетное общее время (в секундах) до завершения всего рецепта.
    - Единицы: секунды.

- LineTimeLeft (ID: 102, float)
    - Назначение: расчетное время (в секундах) до завершения текущего шага.
    - Единицы: секунды.

- IsRecipeConsistent (ID: 103, bool)
    - Назначение: принимает true после отправки или чтения рецепта из ПЛК. При изменении структуры (значения ячеек,
      добавлена/удалена строка, становится false).
    - true/false

## Поведенческие правила, зависящие от входных пинов

- Блокировка редактирования:
    - `RecipeActive = true` переводит таблицу в режим исполнения и блокирует редактирование.
- Разрешение передачи в ПЛК:
    - `EnaSend = true` требуется для операций передачи рецепта в ПЛК; при false такие операции блокируются.
- Индексация шага:
    - `ActualLineNumber` — целое число с нулевой индексацией (0 — первый шаг).

## Работа таймера и зависимость от пинов

Пересчет времен основан на фактическом прогрессе выполнения шага и расписании шагов рецепта.

- Исходные данные для расчета:
    - `ActualLineNumber` (ID: 3) — текущий индекс шага (0‑based).
    - `StepCurrentTime` (ID: 4) — прошедшее время текущего шага (сек).

- Алгоритм расчета (наблюдаемое поведение):
    - Определяется длительность текущего шага как разница между временем начала текущего шага и временем начала
      следующего шага. Для последнего шага границей служит суммарная длительность рецепта.
    - `LineTimeLeft = max(0, Длительность_текущего_шага − StepCurrentTime)`.
    - `TotalTimeLeft = max(0, Общая_длительность_рецепта − (Время_начала_текущего_шага + StepCurrentTime))`.

- Граничные случаи:
    - Если рецептура пуста (нет шагов) — оба выхода устанавливаются в 0 секунд.
    - Если `ActualLineNumber` вне диапазона шагов — оба выхода устанавливаются в 0 секунд.
    - Если данные о времени начала шага недоступны/невалидны — оба выхода устанавливаются в 0 секунд.
