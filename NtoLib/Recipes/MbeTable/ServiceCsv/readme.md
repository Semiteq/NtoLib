# Импорт и экспорт рецептов в CSV

## Что делает модуль

- Загружает CSV-файл рецепта и проверяет его корректность.
- Преобразует CSV-данные в модель Recipe.
- Сохраняет Recipe в CSV с метаданными и контрольной суммой.
- Выполняет валидацию рецепта (структура, циклы, доступность целевых объектов/таргетов).

## Формат файла

Файл состоит из двух блоков:

1. Блок метаданных (строки, начинаются с `#`)
    - Идёт в начале файла до первой строки без `#`.
    - Ключи (регистр не важен):
        - `SEP` — разделитель CSV. Всегда `;`.
        - `ROWS` — количество строк данных (без заголовка). `0` — не задано.
        - `BODY_SHA256` — Base64 от SHA-256 по телу данных (см. ниже).
        - Произвольные пары `X_<Key>=<Value>` — расширяемые метаданные. При экспорте записывается `X_ExportedAtLocalTime` в локальном времени формата `O` (пример: `2025-10-21T13:06:57.3391997+03:00`).
    - Значения по умолчанию, если ключ не встречен: `SEP=';'`, `ROWS=0`, `BODY_SHA256=""`, `Extras={}`.

2. Блок данных (CSV)
    - Первая строка — заголовок, далее строки данных.
    - Разделитель: `;` (фиксирован).
    - Переводы строк: CRLF (`\r\n`).
    - Строка заголовка обязательна.
    - Пробелы в заголовках и значениях обрезаются.
    - Заголовок должен в точности (порядок и состав) совпадать с текущим списком колонок, доступных для записи в конфигурации (т. е. все колонки, у которых `ReadOnly = false`). Сопоставление по коду колонки без учёта регистра.

Форматирование значений при экспорте:
- Целые значения типа short — формат `InvariantCulture`.
- Числа с плавающей точкой (float) — формат `"R"` в `InvariantCulture`.
- Пустые/отсутствующие значения — пустая строка.

Контрольная сумма (`BODY_SHA256`):
- Рассчитывается по «нормализованным» строкам данных без заголовка.
- Для расчёта каждая строка завершается CRLF (`\r\n`).

## Кодировки и переводы строк

- Чтение файла: по умолчанию UTF-8 with BOM; недопустимые байты приводят к ошибке чтения.
- Запись файла: по умолчанию UTF-8 with BOM.
- Переводы строк в создаваемом CSV: CRLF (`\r\n`).

## Загрузка (импорт) из CSV

Процесс состоит из:
1. Чтение и разбор CSV → сырой дамп `CsvRawData` (заголовок, строки, записи, метаданные).
2. Сборка `Recipe` из `CsvRawData` и валидация.

При чтении из файла проверяются метаданные и заголовок; несоответствие `ROWS`/`BODY_SHA256` фиксируется как предупреждение (чтение не прерывается).

Всегда проверяется:
- Наличие строки заголовка и её непустота.
- Полное совпадение заголовка с текущей конфигурацией «доступных для записи» колонок (строго по порядку и составу).

После чтения самого файла происходит валидация данных:
- Колонка действия `Action` обязана присутствовать, значение — корректное целое число.
- Колонки `Action` и `StepStartTime` не записываются в свойства шага.
- Для каждой другой колонки:
    - Если колонка не применима к выбранному действию, но в ячейке есть значение — ошибка.
    - Пустые значения пропускаются.
    - Парсинг значений выполняется в `InvariantCulture`:
        - short — целое число
        - float — число с плавающей точкой
        - иное — ошибка "Unsupported type"
    - Корректность циклов.
    - Доступность таргетов (по каждому шагу и колонке, если колонка привязана к группе и тип не Enum):
        - Пустое значение:
          "row {i}: actionId={id} ('{ActionName}') column '{Key}' requires a target from group '{Group}', but value is empty."
        - Неизвестная группа:
          "row {i}: actionId={id} ('{ActionName}') column '{Key}' references group '{Group}', which is not available."
        - В группе нет таргетов:
          "row {i}: actionId={id} ('{ActionName}') column '{Key}' group '{Group}' has no targets configured."
        - Указанный targetId отсутствует в группе:
          "row {i}: actionId={id} ('{ActionName}') column '{Key}' targetId={targetId} not found in group '{Group}'."

Совокупное сообщение при ошибках таргетов:
```
"Missing or invalid targets in current environment: ..."
```

- При первой ошибке сборка прерывается.
- После успешной сборки выполняется доменная валидация рецепта (структура, циклы, таргеты). При ошибках валидации рецепт возвращается вместе с перечнем ошибок — решение об их «критичности» остаётся на стороне клиента.

## Экспорт (сохранение) в CSV

- Заголовок содержит только колонки, у которых `ReadOnly = false` (в порядке текущей конфигурации).
- Значения форматируются по правилам раздела «Формат файла».
- Метаданные записываются автоматически: `SEP=;`, `ROWS`, `BODY_SHA256`, `X_ExportedAtLocalTime` (локальное время, формат `O`).
- Запись выполняется безопасно через временный файл `<target>.tmp` с последующей атомарной заменой/перемещением.

## Пример файла

```csv
# SEP=;
# ROWS=2
# BODY_SHA256=wExm5M5laaxKXg6ywNCmSfnAgxTrK17xl9qc3X4KWj0=
# X_ExportedAtLocalTime=2025-10-21T13:06:57.3391997+03:00
action;target;task;initial_value;speed;step_duration;comment
10;;;;;10;
10;;;;;10;
```

Примечания к примеру:
- Разделитель — `;`.
- Две строки данных, заголовок соответствует конфигурации «доступных для записи» колонок.
- Контрольная сумма рассчитана по двум строкам данных без заголовка, с CRLF на конце каждой строки.