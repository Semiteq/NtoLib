# Диагностика и логирование

Логирование используется для диагностики работы модуля: загрузка конфигурации, ошибки валидации, обмен с ПЛК, выполнение команд и другие ключевые операции.

## Включение и путь

- Свойство блока "17. Записывать лог в файл"
    - Включено — логирование активно.
    - Выключено — логирование полностью отключено (нет вывода ни в файл, ни в отладочный вывод/консоль).
- Свойство блока "18. Путь к каталогу логов"
    - Каталог для лог‑файлов. Допустимо использовать переменные окружения (например, `%AppData%`, `%USERPROFILE%`).
    - Значение по умолчанию: `%AppData%/NtoLibLogs`

## Имя и расположение файла

- Имя файла: `mbe-table.log`
- Путь по умолчанию: `C:\Users\<Имя_пользователя>\AppData\Roaming\NtoLibLogs\mbe-table.log`
- Итоговый путь формируется как `<Каталог_логов>/mbe-table.log`

Если каталог не существует, приложение попытается создать его автоматически. Если создать каталог/файл невозможно, записи продолжают выводиться в отладочный поток (Output) и консоль (при включённом логировании), а в файл — нет.

## Куда пишутся логи (при включённом логировании)

- Файл `mbe-table.log`
- Консоль
- Окно Output (Debug) в среде разработки

## Уровни и формат записей

- Минимальный уровень: Debug (записываются Debug, Information, Warning, Error, Critical)
- Метка времени: UTC в формате ISO 8601

Шаблон строки:
```
{UTC-метка-времени} [{Уровень}] {Сообщение}
{Исключение-стек-трейс-если-есть}
```

Пример:
```
2025-10-21T10:16:35.0978305Z [DBG] Removing step at index 0
2025-10-21T10:16:35.8309324Z [DBG] Connected to PLC 192.168.0.141:502
2025-10-21T10:16:35.8472923Z [DBG] Ping 1 reg completed in 8 ms
2025-10-21T10:16:35.8563620Z [DBG] Write 2 reg completed in 30 ms
2025-10-21T10:16:35.8611463Z [DBG] WriteAllAreas completed in 35 ms
2025-10-21T10:16:35.8673030Z [DBG] SendRecipe completed in 41 ms
2025-10-21T10:16:35.8743585Z [DBG] PLC disconnected
2025-10-21T10:16:35.8809910Z [ERR] Failed to send recipe to PLC: Control register validation failed. Expected 1, got 2 | Reasons: Control register validation failed. Expected 1, got 2 | Metadata: Codes=PlcInvalidResponse
```

## Ротация и хранение

- Ротация по размеру файла: каждые 5 МБ создаётся новый файл
- Хранится до 5 файлов ротации
- Ротация по времени не используется

## Что фиксируется в логе

- Операции обмена с ПЛК и данные подключения
- Операции с файлами рецептов (чтение/запись), проверка целостности
- Выполнение команд, изменения состояний и диагностические сообщения
- Ошибки и исключения с трассировкой стека

Объём и детализация зависят от конкретных мест, где выполняются записи.