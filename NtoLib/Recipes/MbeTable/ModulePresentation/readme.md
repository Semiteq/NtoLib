# Пользовательский интерфейс и взаимодействие (UI/UX)

## 1. Обзор

Пользовательский интерфейс представляет собой интерактивную таблицу, предназначенную для эффективного создания, редактирования и мониторинга технологических рецептов. Взаимодействие с таблицей построено на стандартных практиках, привычных пользователям по работе с табличными редакторами, с использованием мыши и клавиатуры.

## 2. Режимы выбора: Строка vs. Ячейка

Ключевой концепцией является разделение на два взаимоисключающих режима выбора, от которых зависит поведение операций (в частности, вставки `Ctrl+V`).

| Режим              | Активация                                                              | Цель операций                                |
| :----------------- | :--------------------------------------------------------------------- | :------------------------------------------- |
| **Выбор строки**   | Клик по заголовку строки (область с номером) или навигация `Shift`+стрелки. | Вся строка или группа строк целиком.         |
| **Выбор ячейки**   | Клик по любой редактируемой ячейке внутри строки.                      | Содержимое конкретной ячейки (текст, число). |

## 3. Визуальное представление

-   **Выделенная строка:** Когда строка выбрана, вся ее область подсвечивается отчетливым цветом (например, системным синим цветом выделения), указывая, что операции будут применены к ней целиком.
-   **Активная ячейка:** Когда ячейка выбрана для редактирования, она обводится рамкой фокуса. Это означает, что система готова к вводу данных в эту ячейку.
-   **Исполняемая строка:** Текущий исполняемый шаг (`ActualLineNumber`) подсвечивается отдельным цветом (например, зеленым), что позволяет визуально отслеживать прогресс выполнения рецепта.
-   **Пользовательское выделение vs. исполнение:** Выбранная пользователем строка имеет свой цвет.
-   **Цвета циклов:** Строки, входящие во вложенные циклы, имеют дополнительную фоновую подсветку фиолетовыми оттенками; чем глубже уровень вложенности, тем заметнее цвет.
-   **Совмещение состояний:** Если строка одновременно находится внутри цикла и выполняется, цвет цикла и подсветка исполнения накладываются друг на друга: текущий шаг в цикле подсвечивается ярче, уже выполненные шаги выглядят более приглушёнными, но сохраняют оттенок цикла.
-   **Цвета по умолчанию:** По умолчанию цвет пройденной ячейки установлен в `Transparent`. В этом случае не происходит окраска и сложение коэффициентов затенения.

## 4. Навигация и выделение с клавиатуры

-   **Выделить всё (`Ctrl+A`):** Выделяет все строки в таблице.
-   **Несмежное выделение (`Ctrl` + Click по заголовку строки):** Позволяет добавлять или убирать отдельные строки из выделения, не сбрасывая его.
-   **Выделение диапазона (`Shift` + Click по заголовку / `Shift` + Стрелки):** Позволяет выделить непрерывный блок строк.

## 5. Операции со строками (режим "Выбор строки")

Все операции, изменяющие рецепт, доступны только при `RecipeActive = false`.

#### Копировать строки
-   **Горячая клавиша:** `Ctrl+C`
-   **Действие:** Данные выделенных строк помещаются в буфер обмена в формате TSV (Tab-Separated Values). Копируются только значения колонок с флагом `save_to_csv: true`.
-   **Доступность:** Операция доступна всегда.

#### Вырезать строки
-   **Горячая клавиша:** `Ctrl+X`
-   **Действие:** Данные выделенных строк копируются в буфер, после чего строки удаляются из таблицы.
-   **Влияние на состояние:** `IsRecipeConsistent` устанавливается в `false`.

#### Вставить строки
-   **Горячая клавиша:** `Ctrl+V`
-   **Действие:** Строки из буфера вставляются после текущей выделенной строки. Если ни одна строка не выделена, вставка происходит в конец таблицы.
-   **Валидация:** Перед вставкой данные проходят полную доменную валидацию, аналогичную импорту из CSV. В случае ошибки операция отменяется с уведомлением пользователя.
-   **Влияние на состояние:** `IsRecipeConsistent` устанавливается в `false`.

#### Удалить строки
-   **Горячая клавиша:** `Del`
-   **Действие:** Выделенные строки удаляются из таблицы.
-   **Влияние на состояние:** `IsRecipeConsistent` устанавливается в `false`.

#### Создать новую строку
-   **Горячая клавиша:** `Ctrl+N`
-   **Действие:** Новая строка добавляется после текущей выделенной строки (или в конец, если нет выделения).
-   **Содержимое:** Строка создается с действием и параметрами по умолчанию, определенными в `ActionsDefs.yaml`.
-   **Влияние на состояние:** `IsRecipeConsistent` устанавливается в `false`.

## 6. Операции с ячейками (режим "Выбор ячейки")

-   **Вставка текста (`Ctrl+V`):** В этом режиме `Ctrl+V` выполняет стандартную вставку текста из буфера обмена в активную ячейку. Операция вставки строки при этом не происходит.

## 7. Контекстное меню

-   **Активация:** Правый клик по заголовку строки.
-   **Содержимое:** Меню содержит пункты для всех операций со строками (`Копировать`, `Вырезать`, `Вставить`, `Удалить`, `Создать новую`).
-   **Поведение:** Меню является динамическим. Активность пунктов зависит от текущего состояния:
    -   `Вырезать`, `Копировать`, `Удалить` — активны только при наличии выделенных строк.
    -   `Вставить` — активен, если буфер обмена содержит совместимые данные для вставки строк.
    -   Все изменяющие пункты меню неактивны, если `RecipeActive = true`.

## 8. Общие системные правила

-   **Блокировка редактирования:** Все операции, изменяющие структуру или данные рецепта (`Cut`, `Paste`, `Del`, `New`), должны быть гарантированно заблокированы, когда входной пин `RecipeActive` (ID: 1) имеет значение `true`.
-   **Консистентность рецепта:** Любая успешная операция, изменяющая рецепт, должна устанавливать выходной пин `IsRecipeConsistent` (ID: 103) в `false`.