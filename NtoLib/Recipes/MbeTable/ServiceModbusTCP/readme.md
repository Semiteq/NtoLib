# Взаимодействие с ПЛК по Modbus TCP

## Назначение и общий сценарий

Модуль выполняет:
- Отправку текущего рецепта в ПЛК: запись плоских массивов регистров INT/FLOAT и запись количества строк.
- Чтение «сырых» данных рецепта из ПЛК: чтение количества строк, затем массивов INT/FLOAT.
- После завершения любой операции (отправка/чтение) модуль разрывает соединение с ПЛК.

## Настройки (runtime options) и источники значений

Все нижеперечисленные значения приходят из UI (визуальные свойства блока) и используются модулем во время работы.

Подключение и попытки:
- `IpAddress`: IP-адрес ПЛК (собирается из 4 байт UI, по умолчанию `192.168.0.141`).
- `Port`: TCP-порт Modbus (по умолчанию `502`).
- `UnitId`: идентификатор Modbus-устройства (по умолчанию `69`).
- `TimeoutMs`: таймаут подключения (по умолчанию `1000` мс).
- `MaxRetries`: общее число попыток, включая первую (по умолчанию `3`).
- `BackoffDelayMs`: задержка между попытками (по умолчанию `200` мс).

Контроль и задержка верификации:
- `ControlRegister`: базовый адрес контрольной области (по умолчанию `8000`).
    - `R0 = ControlRegister` — проверка связи (ожидается `MagicNumber`).
    - `R1 = ControlRegister + 1` — количество строк рецепта.
- `MagicNumber`: ожидаемое значение в R0 (по умолчанию `69`).
- `VerifyDelayMs`: фиксированная задержка перед обратным чтением после записи (`200` мс).

Области данных:
- `IntBaseAddr`: начальный адрес области INT (по умолчанию `27700`).
- `IntAreaSize`: размер области INT (по умолчанию `1400` регистров).
- `FloatBaseAddr`: начальный адрес области FLOAT (по умолчанию `8100`).
- `FloatAreaSize`: размер области FLOAT (по умолчанию `19600` регистров).

Порядок слов и сравнение:
- `WordOrder`: порядок слов для FLOAT — HighLow (зафиксировано).
- `Epsilon`: допуск сравнения чисел с плавающей точкой (по умолчанию `1e-4`).

Примечание: Значения по умолчанию указаны для первоначальной конфигурации UI; в реальной среде они задаются оператором через UI.

## Требования к карте памяти ПЛК

```ascii
              КАРТА ПАМЯТИ ПЛК ДЛЯ РЕЦЕПТОВ

+-------------------------------------------------------------+
| КОНТРОЛЬНАЯ ОБЛАСТЬ (UControlBaseAddr)                      |
|-------------------------------------------------------------|
| R0: Валидация (69) | R1: Кол-во строк | R2-R9: Резерв       |
+-------------------------------------------------------------+ 

                              ...

+-------------------------------------------------------------+
| ОБЛАСТЬ INT ДАННЫХ (UIntBaseAddr)                           |
|-------------------------------------------------------------|
| [Все Int-значения для всех строк рецепта идут подряд...]    |
|                                                             |
+-------------------------------------------------------------+

                              ...

+-------------------------------------------------------------+
| ОБЛАСТЬ FLOAT ДАННЫХ (UFloatBaseAddr)                       |
|-------------------------------------------------------------|
| [Все Float-значения для всех строк рецепта идут подряд...]  |
| (Каждое Float значение занимает 2 регистра)                 |
+-------------------------------------------------------------+
```

Контрольная область (`ControlRegister`):
- R0: регистр валидации — должен содержать `MagicNumber`.
- R1: количество строк рецепта (неотрицательное целое).
- Остальные регистры контрольной области модулем TCP не используются.

| Смещение | Регистр | Назначение                                                         |
|:---|:---|:-------------------------------------------------------------------|
| **+0** | **R0** | **Регистр валидации.** Ex: 69                                    |
| **+1** | **R1** | **Количество строк рецепта.** Сюда записывается общее число шагов. |
| +2..+9 | R2-R9 | Зарезервировано.                                                   |

Область INT (`IntBaseAddr`, `IntAreaSize`):
- Содержит 16-битные значения INT для всех строк подряд (строка за строкой).

Область FLOAT (`FloatBaseAddr`, `FloatAreaSize`):
- Содержит значения типа float (IEEE 754) для всех строк подряд (строка за строкой).
- Каждое float-значение занимает 2 регистра Modbus.
- Порядок слов — HighLow.

Разметка колонок:
- Для каждой области (INT/FLOAT) используется ширина строки, равная (максимальный индекс колонки в этой области) + 1.
- Требуемый объём под данные:
    - INT: `rows * IntColumnCount`
    - FLOAT: `rows * (FloatColumnCount * 2)`

## Формат данных INT/FLOAT

- INT:
    - 1 значение = 1 регистр (16 бит, знаковый диапазон short).
- FLOAT:
    - 1 значение = 2 регистра (32-битный float).
    - Порядок слов — HighLow.

## Отправка рецепта (Send)

1. Проверка вместимости:
    - INT: требуемо `rows * IntColumnCount` регистров.
    - FLOAT: требуемо `rows * (FloatColumnCount * 2)` регистров.
    - Сравнивается с `IntAreaSize`/`FloatAreaSize`. При нехватке — операция не выполняется.

2. Подключение и валидация:
    - Устанавливается соединение.
    - Выполняется «пинг»: чтение R0 и сверка с `MagicNumber`. Несовпадение считается невалидным соединением.

3. Сериализация:
    - Рецепт преобразуется в два массива регистров: `int[]` и `float[]`.
    - FLOAT сериализуется с порядком слов HighLow.

4. Запись данных:
    - Сначала область INT (если есть данные), затем область FLOAT (если есть данные).
    - Большие объёмы разбиваются на пакеты до 123 регистров.

5. Запись количества строк:
    - В R1 записывается общее число строк.

6. Задержка перед обратным чтением:
    - Фиксированная `VerifyDelayMs = 200` мс.

7. Обратное чтение и сравнение по значениям с допуском по float (`Epsilon`):
    - Считываются R1, затем соответствующие объёмы INT/FLOAT.

8. Завершение:
    - Соединение с ПЛК разрывается.

## Чтение рецепта (Receive)

1. Подключение и валидация:
    - Устанавливается соединение.
    - Выполняется «пинг»: чтение R0 и сверка с `MagicNumber`.

2. Чтение количества строк:
    - Считывается R1.
    - Если R1 = 0 — возвращаются пустые массивы и `RowCount = 0`.

3. Расчёт размеров и чтение массивов:
    - INT: `rows * IntColumnCount` регистров с `IntBaseAddr`.
    - FLOAT: `rows * (FloatColumnCount * 2)` регистров с `FloatBaseAddr`.

4. Завершение:
    - Соединение разрывается.
    - Возвращаются «сырые» массивы регистров и `RowCount`.

## Повторные попытки, таймауты и разрывы соединения

- Повторы:
    - Общее число попыток = `MaxRetries` (включая первую).
    - Задержка между попытками = `BackoffDelayMs`.
    - Повторы делаются при ошибках ввода-вывода, сетевых ошибках и исключениях Modbus-библиотеки.
- Таймаут подключения:
    - `TimeoutMs` применяется к установлению соединения.
- Разрыв соединения:
    - После каждой операции (Send/Receive) соединение разрывается.
    - При операционных ошибках чтения/записи соединение может быть разорвано досрочно.