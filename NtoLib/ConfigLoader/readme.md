# ConfigLoader — Функциональный блок загрузки конфигурации

![ConfigLoader.png](ConfigLoader.png)

Функциональный блок для динамической загрузки и сохранения именованных настроек оборудования из YAML-файла конфигурации.

## Назначение

ConfigLoader позволяет централизованно хранить и управлять именами оборудования (заслонок, источников, нагревателей, водяных каналов и газовых линий) в единственном конфигурационном файле. Блок обеспечивает:

- Загрузку конфигурации при старте системы
- Сохранение изменений по команде оператора
- Валидацию имён оборудования
- Автоматическое создание файла конфигурации при первом запуске

## Структура данных

### Группы оборудования

| Группа | Количество элементов | Описание |
|--------|---------------------|----------|
| Shutter | 16 | Заслонки |
| Sources | 32 | Источники |
| ChamberHeater | 16 | Нагреватели камеры |
| Water | 16 | Водяные каналы |
| Gases | 16 | Газовые линии |

### Формат файла конфигурации

Файл хранится в формате YAML по пути `C:\DISTR\Config\NamesConfig.yaml` (настраивается).

```yaml
Shutter:
  1: "Заслонка Ga"
  2: "Заслонка Al"
  3: ""
  ... 
  16: ""
Sources:
  1: "Галлий"
  2: "Алюминий"
  ... 
  32: ""
ChamberHeater:
  1: "Нагреватель 1"
  ... 
  16: ""
Water:
  1: "ТМН"
  ...
  16: ""
Gases:
  1: "Линия газа 1"
  ...
  16: ""
```

## Интерфейс функционального блока

### Входы (Pin)

| Имя | Тип | Описание |
|-----|-----|----------|
| Save | bool | Команда сохранения (по фронту 0→1) |
| Shutter_IN[1.. 16] | string | Входы для записи имён заслонок |
| Sources_IN[1..32] | string | Входы для записи имён источников |
| ChamberHeater_IN[1.. 16] | string | Входы для записи имён нагревателей |
| Water_IN[1..16] | string | Входы для записи имён водяных каналов |
| Gases_IN[1..16] | string | Входы для записи имён газовых линий |

### Выходы (Pout)

| Имя | Тип | Описание |
|-----|-----|----------|
| Loaded | bool | Флаг успешной загрузки конфигурации |
| Saved | bool | Флаг успешного сохранения (активен 1 сек) |
| Error | string | Текст ошибки (пусто при успехе) |
| Shutter_OUT[1..16] | string | Текущие имена заслонок из файла |
| Sources_OUT[1.. 32] | string | Текущие имена источников из файла |
| ChamberHeater_OUT[1..16] | string | Текущие имена нагревателей из файла |
| Water_OUT[1..16] | string | Текущие имена водяных каналов из файла |
| Gases_OUT[1..16] | string | Текущие имена газовых линий из файла |

### Свойства блока

| Свойство | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| Путь к файлу конфигурации | string | `C:\DISTR\Config\NamesConfig.yaml` | Полный путь к YAML-файлу |

## Дерево пинов

```
ConfigLoader
├── Save (Pin, bool)
├── Loaded (Pout, bool)
├── Saved (Pout, bool)
├── Error (Pout, string)
├── Shutters_IN/
│   ├── 1 (Pin, string)
│   ├── 2 (Pin, string)
│   └── ...  16
├── Shutters_OUT/
│   ├── 1 (Pout, string)
│   ├── 2 (Pout, string)
│   └── ... 16
├── Sources_IN/
│   ├── 1 (Pin, string)
│   └── ... 32
├── Sources_OUT/
│   ├── 1 (Pout, string)
│   └── ... 32
├── ChamberHeaters_IN/
│   ├── 1 (Pin, string)
│   └── ... 16
├── ChamberHeaters_OUT/
│   ├── 1 (Pout, string)
│   └── ... 16
├── Water_IN/
│   ├── 1 (Pin, string)
│   └── ... 16
├── Water_OUT/
│   ├── 1 (Pout, string)
│   └── ...  16
├── Gases_IN/ (опционально, если используется группа газовых линий)
│   ├── 1 (Pin, string)
│   └── ... 16
└── Gases_OUT/ (опционально)
    ├── 1 (Pout, string)
    └── ... 16
```

## Логика работы

### При инициализации (переход в Runtime)

1. Проверка существования файла конфигурации
2. Если файл не существует — создание файла с пустыми значениями
3.  Чтение и парсинг YAML-файла
4. Валидация структуры и значений
5.  Заполнение всех `*_OUT` пинов значениями из файла
6. Установка `Loaded = true` при успехе
7. При ошибке: `Loaded = false`, описание в `Error`

### При сохранении (фронт Save 0→1)

1. Чтение всех значений из `*_IN` пинов
2.  Валидация имён
3.  Запись в YAML-файл
4. Повторное чтение файла
5. Обновление всех `*_OUT` пинов
6. Установка `Saved = true` на 1 секунду
7.  При ошибке: `Saved = false`, описание в `Error`

## Валидация имён

### Допустимые символы

- Латинские буквы: `A-Z`, `a-z`
- Кириллица: `А-Я`, `а-я`, `Ё`, `ё`
- Цифры: `0-9`
- Специальные символы: пробел, точка `. `, дефис `-`, подчёркивание `_`

### Ограничения

- Максимальная длина имени: 254 символа
- Пустые имена разрешены

### Примеры валидных имён

```
Заслонка 1
Source-Ga
Heater_Main.2
Al Source
```

### Примеры невалидных имён

```
Name@Invalid    (символ @)
Source#1        (символ #)
Test<Name>      (символы < >)
```
